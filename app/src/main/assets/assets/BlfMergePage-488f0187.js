import{H as k}from"./Header-0c7457b8.js";import{C as x}from"./CopyPath-f922bb6f.js";import{B as E}from"./Button-90007b30.js";import{_ as q,z as f,k as b,j as S,e as y,r as F,l as B,c as n,h as p,d as s,F as C,m as M,i as T,a,t as h,f as P,w as L,v as V,o as c,n as N,p as j,b as I}from"./index-60fbc380.js";import{n as g}from"./index-87144d51.js";let D=0;const O={props:["store","closeFlag"],components:{Button:E,Header:k,CopyPath:x},data(){return{pullType:"blf",chartDataLoaded:!0,directory:"",fileDirectory:[],fileDirectoryStr:"",recList:{csv:{label:"csv",size:"",paths:"/persistence/vde/pool,/tmp/vde/pool"},asc:{label:"asc",size:"",paths:"/log/DiagMaster,/persistence/DiagMaster"},blf:{label:"blf",size:"",paths:"/log/DiagMaster,/persistence/DiagMaster"}},recLoading:!1,recLoadingProgress:"",recordTime:"00:00:00",consoleText:"",message:{visible:!1,level:"",content:""},fileName:"",saveFilename:"",inputFiles:[],mergeDataValid:!1,showWaitWarn:!1,showWaitWarnMsg:"",showPathWarn:!1,showPathWarnMsg:"",computedArr:[],seletFileList:{noAdapted:{label:"blf",value:"blf"},adapted:{label:"asc",value:"asc"}},fileType:"noAdapted",fileTypesList:[]}},watch:{chartDataLoaded(t,r){t?(document.querySelector("#app").style.cursor="",document.querySelector(".back-icon").style.pointerEvents="",document.querySelector(".record-header").style.cursor="",document.querySelector(".waitMergeFile").style.pointerEvents="",document.querySelector(".outputFilePath").style.pointerEvents="",document.querySelector(".o-pul-er").style.pointerEvents="",document.querySelector(".o-menu").style.pointerEvents=""):(document.querySelector("#app").style.cursor="wait",document.querySelector(".back-icon").style.pointerEvents="none",document.querySelector(".waitMergeFile").style.pointerEvents="none",document.querySelector(".outputFilePath").style.pointerEvents="none",document.querySelector(".o-pul-er").style.pointerEvents="none",document.querySelector(".o-menu").style.pointerEvents="none")},inputChanged:{handler(t,r){if(console.log("newVal,oldVal",t,r),t){let d=this.fileType=="noAdapted"?[e=>!/.blf$/i.test(e),"输出文件要以.blf结尾"]:[e=>!/.asc$/i.test(e),"输出文件要以.asc结尾"],o=[[e=>!e.length,"请选择待合并文件"],[e=>e.some(i=>/[\s]/g.test(i.file_name)),"路径中不能包含空格"],[e=>e.some(i=>i.file_name.toLowerCase()==this.directory.toLowerCase()),"输出文件不能与输入文件重名"]].find(e=>e[0](this.inputFiles));this.showWaitWarn=!!o,this.mergeDataValid=!o,this.showWaitWarnMsg=o?o[1]:"",console.log("wait",o),o=[[e=>!e,"请选择路径"],d,[e=>/[\s]/g.test(e),"路径中不能包含空格"],[e=>this.inputFiles.some(i=>i.file_name.toLowerCase()==e.toLowerCase()),"输出文件不能与输入文件重名"]].find(e=>e[0](this.directory)),this.showPathWarn=!!o,this.mergeDataValid=!o,this.showPathWarnMsg=o?o[1]:"",console.log("path",o)}},deep:!0}},mounted(){const t=window.driver.js.driver({doneBtnText:"知道了",closeBtnText:"关闭",nextBtnText:"继续",prevBtnText:"后退",steps:[{element:"#el-record-form",popover:{title:"配置和录制",description:"填写格式和目录信息，点击开始"}},{element:"#el-record-console",popover:{title:"进度提示",description:"此区域提示录制进度"}}]});this.$ls.get("driverRecord")||(t.drive(),this.$ls.set("driverRecord",!0)),S.report("trackPage",{page:"合并报文",tip:"1174.1.0.1.27747"})},computed:{inputChanged(){return[this.directory,this.inputFiles]},quitConfirm(){return!!this.directory.trim()}},unmounted(){},methods:{choosePath(){console.log(this.directory),this.fileType=="noAdapted"?(this.fileTypesList=["BLF文件 (*.blf;*.BLF)"],this.saveFilename="tspa-merge-"+f()+".blf"):(this.saveFilename="tspa-merge-"+f()+".asc",this.fileTypesList=["ASC文件 (*.asc;*.ASC)"]),b.choosePath({directory:this.directory.split("/").slice(0,-1).join("/")||window.downloadPath,saveFilename:this.saveFilename,dialogType:"SAVE_DIALOG",fileTypes:this.fileTypesList,allow_multiple:!1}).then(({data:t})=>{console.log("9292929",t),t.directory&&(this.directory=g(t.directory))})},fileListFun(){this.directory="",this.fileDirectory=[],this.consoleText=""},chooseFile(){let t=[];const r=this.directory.split("/").slice(0,-1).join("/");this.fileType=="noAdapted"?this.fileTypesList=["BLF文件 (*.blf;*.BLF)"]:this.fileTypesList=["ASC文件 (*.asc;*.ASC)"],b.choosePath({directory:r,dialogType:"OPEN_DIALOG",fileTypes:this.fileTypesList,allow_multiple:!0}).then(d=>{if(d.data.directory){console.log("这里this.directory",this.directory),this.fileDirectory=d.data.directory.sort((e,i)=>e.split("/").pop()>i.split("/").pop()?1:-1).map(e=>g(e)),this.fileDirectoryStr=this.fileDirectory.join(",");var o=/[,]/g;this.fileDirectoryStr=this.fileDirectoryStr.toString().replace(o,"$&\r\n"),this.fileDirectory.forEach((e,i)=>{i===0&&(this.directory||(this.fileType=="noAdapted"?this.directory=g(e.split("/").slice(0,-1).join("/")+"/merge-"+f()+".blf"):this.directory=g(e.split("/").slice(0,-1).join("/")+"/merge-"+f()+".asc")));let m={file_name:e};t.push(m)}),console.log("this.inputFiles",t),this.inputFiles=t}})},checkPath(t){return!(/[\u4E00-\u9FA5]|[\uFE30-\uFFA0]/g.test(t)||/\s/g.test(t))},async startMerge(){if(S.report("track","click",{element_name:"开始合并",asset_name:this.fileDirectory.join(","),tip:"1174.1.0.1.27733"}),this.showWaitWarn==!1&&this.showPathWarn==!1){this.consoleText="合并中...\n",this.chartDataLoaded=!1,this.mergeDataValid=!1;let t=this.directory;D=setInterval(()=>{this.wheelMergeFile()},1e3),this.fileType=="noAdapted"?await y.blfMerge.mergeFile({input_files:JSON.parse(JSON.stringify(this.inputFiles)),output_file:t}).finally(()=>{clearInterval(D),setTimeout(async()=>{await this.wheelMergeFile(),this.consoleText+="合并结束\n",this.chartDataLoaded=!0,this.mergeDataValid=!0},1e3)}):await y.ascMerge.mergeAscFile({input_files:JSON.parse(JSON.stringify(this.inputFiles)),output_file:t}).finally(()=>{clearInterval(D),setTimeout(async()=>{await this.wheelMergeFile(),this.consoleText+="合并结束\n",this.chartDataLoaded=!0,this.mergeDataValid=!0},1e3)})}else this.mergeDataValid=!1},async wheelMergeFile(){let r=await(this.fileType=="noAdapted"?y.blfMerge.getExeLog():y.ascMerge.getExeAscLog());console.log("res",r);let d=r.data.data;r.status=="200"&&d.forEach(o=>{this.consoleText+=o+"\n"})}}},l=t=>(j("data-v-8f1bd9f7"),t=t(),I(),t),z=["data-disabled"],H={class:"o-pul-er",id:"el-record-form"},J=l(()=>s("div",{class:"o-pul-title"},"文件合并配置",-1)),R={class:"o-pul-p"},G=l(()=>s("span",{style:{color:"red"}},"* ",-1)),U=l(()=>s("span",{class:"record-header-message"},"待合并文件格式：",-1)),K=["value"],Q={class:"o-pul-p"},X=l(()=>s("span",{style:{color:"red"}},"* ",-1)),Y=l(()=>s("span",{class:"record-header-message"},"待合并文件：",-1)),Z={key:0,class:"o-warn"},$=l(()=>s("i",{class:"warn-icon"},null,-1)),ee={class:"o-pul-p ="},te=l(()=>s("span",{style:{color:"red"}},"* ",-1)),se=l(()=>s("span",{class:"record-header-message"},"输出文件路径：",-1)),oe={class:"o-pul-path"},ie={key:0,class:"o-warn"},re=l(()=>s("i",{class:"warn-icon"},null,-1)),le={class:"o-pul-p start-rec"},ae=l(()=>s("i",{class:"play-icon"},null,-1)),ne=["data-empty"],ce=l(()=>s("div",{class:"o-console-title"},"合并结果",-1)),de=["data-loading"];function pe(t,r,d,o,e,i){const m=F("Header"),_=F("Button"),W=F("CopyPath"),A=B("tooltip");return c(),n("div",{class:"record-page","data-disabled":!e.chartDataLoaded},[p(m,{title:"合并报文",quitConfirm:i.quitConfirm,showRight:!0,carNum:t.$props.store.connectCar.carNum,connectStatus:t.$props.store.connectCar.status,recentTest:t.$props.store.connectCar.latest},null,8,["quitConfirm","carNum","connectStatus","recentTest"]),s("div",H,[J,s("div",R,[G,U,(c(!0),n(C,null,M(e.seletFileList,(v,u)=>(c(),n("label",{class:"o-input record-header-message-imp",onChange:r[1]||(r[1]=(...w)=>i.fileListFun&&i.fileListFun(...w)),key:u},[a(" "),L(s("input",{name:"pull_type",type:"radio","onUpdate:modelValue":r[0]||(r[0]=w=>e.fileType=w),value:u},null,8,K),[[N,e.fileType]]),a(h(v.label),1)],32))),128))]),s("div",Q,[X,Y,p(_,{onClick:i.chooseFile,class:"choose-path waitMergeFile"},{default:T(()=>[a("选择文件")]),_:1},8,["onClick"]),a("  "),(c(!0),n(C,null,M(e.fileDirectory,(v,u)=>(c(),n("div",{class:"o-pul-file",key:u},[p(W,{path:v,length:60},null,8,["path"])]))),128)),e.showWaitWarn?(c(),n("div",Z,[$,a(h(e.showWaitWarnMsg),1)])):P("",!0)]),s("div",ee,[te,se,p(_,{onClick:i.choosePath,class:"choose-path outputFilePath"},{default:T(()=>[a("选择路径")]),_:1},8,["onClick"]),a("  "),s("span",oe,[L((c(),n("span",null,[a(h(e.directory),1)])),[[A,{content:e.directory,skidding:0,arrowPadding:9999},void 0,{"top-start":!0}]])]),e.showPathWarn?(c(),n("div",ie,[re,a(h(e.showPathWarnMsg),1)])):P("",!0)]),s("div",le,[p(_,{type:"primary",disabled:!e.mergeDataValid,progress:e.recLoadingProgress,loading:e.recLoading,onClick:i.startMerge},{default:T(()=>[ae,a(" 开始合并")]),_:1},8,["disabled","progress","loading","onClick"])])]),s("div",{class:"o-console-er","data-empty":e.consoleText==="",id:"el-record-console"},[ce,L(s("div",{class:"o-console-body","data-loading":!e.chartDataLoaded},h(e.consoleText),9,de),[[V,e.consoleText]])],8,ne)],8,z)}const me=q(O,[["render",pe],["__scopeId","data-v-8f1bd9f7"]]);export{me as default};
