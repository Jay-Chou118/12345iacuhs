import{B}from"./Button-b8afde1b.js";import{M as L}from"./Message-c1bea39a.js";import{_ as U,k as v,s as w,e as u,S as x,r as k,l as S,c as _,d as e,t as d,h as r,i as h,a as c,w as b,v as V,j as M,o as m,p as P,b as E}from"./index-77d71887.js";import{B as T}from"./ButtonGroup-0ca77b22.js";const G=""+new URL("logo-04bf574b.png",import.meta.url).href;let D=0;const I={props:["store"],components:{Button:B,ButtonGroup:T,Message:L},data(){return{theme:{options:[{label:"跟随系统",value:"follow"},{label:"浅色",value:"light"},{label:"深色",value:"dark"}],mode:"follow"},user:window._userInfo,debug:window._debug,modal:{visible:!1},popUpdateModal:{visible:!1},newestVersion:"",localVersion:"",localDBCVersion:"",latestLocalDBCVersion:"",btnCheckFlag:"noChecked",updateDataLoaded:!0,updateLoading:!1,updateDBCVersionLoading:!1,updateProgress:"",updateDBCVersionProgress:"",updatePath:"",message:{visible:!1,level:"",content:""}}},watch:{"theme.mode"(t){document.documentElement.setAttribute("theme",t),this.$ls.set("theme",t)},updateDataLoaded(t,s){t?(document.querySelector("#app").style.cursor="",document.querySelector(".o-body").style.pointerEvents="",document.querySelector(".o-menu").style.pointerEvents=""):(document.querySelector("#app").style.cursor="wait",document.querySelector(".o-body").style.pointerEvents="none",document.querySelector(".o-menu").style.pointerEvents="none")}},computed:{pullDataValid(){return!!(this.directory&&this.pullType)},expDay(){return this.user.exp>0?parseInt((this.user.exp*1e3-Date.now())/24/36e5):0}},mounted(){this.checkUpset(),this.getLocalDBCVersion(),this.theme.mode=this.$ls.get("theme"),M.report("trackPage",{page:"设置",tip:"1174.9.0.1.27761"})},unmounted(){},methods:{setTheme(t){let s=document.querySelector("#theme-style");s&&t==="light"?s.parentElement.removeChild(s):!s&&t==="dark"&&(s=document.createElement("style"),s.innerHTML="html,img{filter: invert(.9) hue-rotate(.5turn)}img{opacity: .75}",document.body.appendChild(s))},cannelPopUpdateModal(){this.popUpdateModal.visible=!1},readChangelog(){let t="https://xiaomi.f.mioffice.cn/docx/doxk439aDwvVEaJ5T0ZFL0ajLFd";v.openWeb(t)},goHelp(){let t="https://xiaomi.f.mioffice.cn/docx/doxk4UIXGVGMfVTv798lNcwlmWG";v.openWeb(t)},goCs(){let t="lark://applink.feishu.cn/client/chat/chatter/add_by_link?link_token=1cfib1d2-9877-4062-bc03-6c41be677j6i";if(w=="windows"){let s=document.createElement("iframe");s.src=t,s.style.opacity="0",s.style.position="fixed",s.style.pointerEvents="none",document.body.appendChild(s),setTimeout(()=>{document.body.removeChild(s)},100)}else v.openWeb(t)},checkUpset(){w==="windows"&&(this.localVersion=v.getVersion(),u.base.GetLatestVersion().then(({data:t})=>{t.latest_version&&(this.newestVersion=t.latest_version,this.localVersion==this.newestVersion?this.btnCheckFlag="":(this.btnCheckFlag="update",this.popUpdateModal.visible=!0))}).catch(t=>{t&&(this.btnCheckFlag="noChecked")}))},async clickDBCVersionUpset(){this.updateDBCVersionLoading=!0,this.updateDataLoaded=!1,await u.confUpdate.update({file_type:"DBC",new_version:this.latestLocalDBCVersion}).then(async t=>{t.data.code===0&&(this.localDBCVersion=this.latestLocalDBCVersion,await u.confUpdate.get_newConf({file_type:"DBC"}).then(s=>{let p=s.data,C=[];for(let o in p){let l=[];for(let a in p[o]){let g=Object.keys(p[o][a]).map(f=>+f),y=Array.from({length:Math.max(...g)+1},(f,i)=>g.includes(i)?p[o][a][""+i].replace(/^Channel \d+:/,""):"");l.unshift({label:a,value:a,comments:y})}C.push({label:o,value:o,children:l})}x.DEFAULT=C}))}).catch(t=>{this.showMessage({level:"error",content:t.msg,timeout:2e3})}).finally(()=>{this.updateDBCVersionLoading=!1,this.updateDataLoaded=!0})},getLocalDBCVersion(){u.confUpdate.getCurrentVersion({file_type:"DBC"}).then(t=>{this.localDBCVersion=t.data.current_version})},async clickUpset(){this.popUpdateModal.visible=!1,this.updateDataLoaded=!1,this.updateLoading=!0,D=setInterval(()=>{this.wheelGetVersion()},1e3),await u.swUpdate.pullSoftware({latest_version:this.newestVersion}).then(t=>{this.updatePath=t.data}).finally(()=>{clearInterval(D),this.updateLoading=!1,this.updateDataLoaded=!0,this.modal.visible=!0})},async wheelGetVersion(){let t=await u.swUpdate.getROP();this.updateProgress=t.data+"%"},async updateVersion(){await u.swUpdate.Update({load_path:this.updatePath})},submit(){this.updateVersion()},cannel(){this.modal.visible=!1},async checkUpsetVersion(){await u.confUpdate.getLastestConf({file_type:"DBC"}).then(t=>{t.status===200&&(this.latestLocalDBCVersion=t.data.DBC_latest_version)})},showMessage({level:t,content:s,timeout:p}){clearTimeout(msgTimer),t!=null&&(this.message.level=t),s!=null&&(this.message.content=s),this.message.visible=!0,p>0&&(msgTimer=setTimeout(()=>{this.message.visible=!1},p))}}},n=t=>(P("data-v-5227b5a4"),t=t(),E(),t),F={class:"setting-page"},q=n(()=>e("div",{class:"setting-page-header"},"设置",-1)),A={class:"setting-er"},N={class:"setting-content"},H=n(()=>e("h2",null,"App",-1)),j=n(()=>e("hr",null,null,-1)),R={key:0,class:"btn-wrap"},O=n(()=>e("span",null,"未监测到新版本。点击“检查更新”试试~",-1)),W={key:1,class:"btn-wrap"},J={key:2,class:"btn-wrap"},K=n(()=>e("hr",null,null,-1)),X={key:3,class:"btn-wrap"},Z=n(()=>e("span",null,"未监测到新版本。点击“检查更新”试试~",-1)),z={key:4,class:"btn-wrap"},Q={key:5,class:"btn-wrap"},Y=n(()=>e("hr",null,null,-1)),$=n(()=>e("h3",null,"主题",-1)),ee=n(()=>e("hr",null,null,-1)),te=n(()=>e("h3",null,"获取帮助",-1)),se=n(()=>e("br",null,null,-1)),oe=n(()=>e("h2",null,"账户",-1)),le=n(()=>e("hr",null,null,-1)),ne=n(()=>e("h3",null,"你的账户",-1)),ae={class:"avatar"},ie=["src"],re=n(()=>e("br",null,null,-1)),de=n(()=>e("br",null,null,-1)),ce={class:"icon-ques"},he={class:"o-modal-wrap"},pe={class:"o-modal"},ue={class:"o-modal-header"},_e={class:"o-modal-header-wrap"},me=n(()=>e("div",{class:"o-modal-title"},"提示",-1)),ge=n(()=>e("div",{class:"o-modal-container"},[e("span",{class:"record-header-message"},"确认更新最新版本？")],-1)),fe={class:"o-modal-footer"},ve={class:"o-modal-footer-wrap"},Ce={class:"o-modal-wrap"},ye={class:"o-modal"},ke={class:"o-modal-header"},be={class:"o-modal-header-wrap"},we=n(()=>e("div",{class:"o-modal-title"}," ",-1)),Ve={class:"o-modal-container"},De=n(()=>e("img",{src:G,class:"update-logo"},null,-1)),Be=n(()=>e("br",null,null,-1)),Le={class:"record-header-message"},Ue={class:"o-modal-footer"},xe={class:"o-modal-footer-wrap"};function Se(t,s,p,C,o,l){const a=k("Button"),g=k("ButtonGroup"),y=k("Message"),f=S("tooltip");return m(),_("div",F,[q,e("div",A,[e("div",N,[H,j,e("h3",null,"当前版本："+d(o.localVersion),1),e("div",null,[e("a",{class:"link",onClick:s[0]||(s[0]=(...i)=>l.readChangelog&&l.readChangelog(...i))},"阅读更新日志")]),o.btnCheckFlag=="noChecked"?(m(),_("div",R,[O,r(a,{style:{float:"right"},onClick:l.checkUpset},{default:h(()=>[c("检查更新")]),_:1},8,["onClick"])])):o.btnCheckFlag==""?(m(),_("div",W,[e("span",null,"（在线程序版本："+d(o.newestVersion)+"）你使用的是最新版本！",1),r(a,{style:{float:"right"},onClick:l.checkUpset},{default:h(()=>[c("检查更新")]),_:1},8,["onClick"])])):(m(),_("div",J,[e("span",null,"（在线程序版本："+d(o.newestVersion)+"）你使用的不是最新版本,请下载更新！",1),r(a,{style:{float:"right"},onClick:l.clickUpset,type:"primary",progress:o.updateProgress,loading:o.updateLoading},{default:h(()=>[c("下载更新")]),_:1},8,["onClick","progress","loading"])])),K,e("h3",null,"当前DBC版本："+d(o.localDBCVersion),1),o.latestLocalDBCVersion==""?(m(),_("div",X,[Z,r(a,{style:{float:"right"},onClick:l.checkUpsetVersion},{default:h(()=>[c("检查更新")]),_:1},8,["onClick"])])):o.latestLocalDBCVersion==o.localDBCVersion?(m(),_("div",z,[e("span",null,"（在线程序版本："+d(o.latestLocalDBCVersion)+"）你使用的是最新版本！",1),r(a,{style:{float:"right"},onClick:l.checkUpsetVersion},{default:h(()=>[c("检查更新")]),_:1},8,["onClick"])])):(m(),_("div",Q,[e("span",null,"（在线程序版本："+d(o.latestLocalDBCVersion)+"）你使用的不是最新版本,请下载更新！",1),r(a,{style:{float:"right"},onClick:l.clickDBCVersionUpset,type:"primary",progress:o.updateDBCVersionProgress,loading:o.updateDBCVersionLoading},{default:h(()=>[c("下载更新")]),_:1},8,["onClick","progress","loading"])])),Y,$,e("div",null,[r(g,{options:o.theme.options,class:"theme-btn-group",modelValue:o.theme.mode,"onUpdate:modelValue":s[1]||(s[1]=i=>o.theme.mode=i)},null,8,["options","modelValue"])]),ee,te,e("div",null,[c("获取关于使用软件的 "),e("a",{class:"link",onClick:s[2]||(s[2]=(...i)=>l.goHelp&&l.goHelp(...i))},"帮助手册"),r(a,{style:{float:"right"},onClick:l.goCs},{default:h(()=>[c("联系客服")]),_:1},8,["onClick"])]),se,oe,le,ne,e("div",null,[e("span",ae,[e("img",{src:o.user.avatar},null,8,ie)]),e("span",null,d(o.user.displayName)+"（"+d(o.user.email)+"）"+d(o.user.departmentName),1),re,de,e("span",null,"许可证将在 "+d(l.expDay)+" 天后过期",1),b(e("span",ce,null,512),[[f,"离线持续使用超15天后许可证失效，需连接内网自动续期。",void 0,{right:!0}]])])])]),b(e("div",he,[e("div",pe,[e("div",ue,[e("div",_e,[me,e("i",{class:"o-modal-title-close",onClick:s[3]||(s[3]=(...i)=>l.cannel&&l.cannel(...i))})])]),ge,e("div",fe,[e("div",ve,[r(a,{style:{width:"52px"},onClick:l.cannel},{default:h(()=>[c("取消")]),_:1},8,["onClick"]),r(a,{type:"primary",style:{width:"82px",margin:"0 0px 0 10px"},onClick:l.submit},{default:h(()=>[c("退出并更新")]),_:1},8,["onClick"])])])])],512),[[V,this.modal.visible]]),b(e("div",Ce,[e("div",ye,[e("div",ke,[e("div",be,[we,e("i",{class:"o-modal-title-close",onClick:s[4]||(s[4]=(...i)=>l.cannelPopUpdateModal&&l.cannelPopUpdateModal(...i))})])]),e("div",Ve,[De,Be,e("div",Le,[e("b",null,"发现新版本 "+d(o.newestVersion),1)])]),e("div",Ue,[e("div",xe,[r(a,{type:"primary",style:{width:"82px",margin:"0 0px 0 10px"},onClick:l.clickUpset},{default:h(()=>[c("下载更新")]),_:1},8,["onClick"])])])])],512),[[V,this.popUpdateModal.visible]]),r(y,{message:o.message},null,8,["message"])])}const Ge=U(I,[["render",Se],["__scopeId","data-v-5227b5a4"]]);export{Ge as default};
