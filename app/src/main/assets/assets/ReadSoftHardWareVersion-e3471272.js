import{H as U}from"./Header-6b551eeb.js";import{B as N}from"./Button-c1c8dd8f.js";import{M as A}from"./Message-8b8c302b.js";import{_ as x,e as _,k as R,r as C,c as b,h as u,d as o,i as m,B as p,F as M,m as P,j as y,o as V,a as S,t as f,p as B,b as T}from"./index-7629f9db.js";import{S as q}from"./Spin-b4ad137a.js";function w(e){if(e==""||e==null)return"--";{let r=e.split("S");if(r.splice(0,1),r.length>=1){r=r.map((a,l)=>(a="App"+(l+1)+": S"+a,console.log("el>>>>",a),a)),r=r.join(",");var t=/[,]/g;return r=r.toString().replace(t,"$&\n"),r}}}let L=0,E=0;const W={props:["store","closeFlag"],components:{Button:N,Header:U,Message:A,Spin:q},data(){return{tableList:[],ECUVersion:"ACU,ADD,AMP,BCP,BCS,BLEM,BLEA,BMDM,BMS,CCU,DCD,EPS,EPS2,ETC,FEDS,FLRL,FLSR,FRSR,FZCU,LRR,LSL,LZCU,NEM,REDS,RLSR,RRSR,RSL,RZCU,SCU,SWM,TBOX,TZCU,VCCD,WPC".split(",").sort(),didList:new Set,softStatus:"未上报,正常,即将到期,超期,豁免,未安装".split(","),ECUVal:"",DIDVal:[{value:"0xF1A0"}],SoftStatusVal:"",carInfo:{VINNumber:""},pullLocalLoading:!1,pullCloudLoading:!1,pullLoadingProgress:0,comparisonFlag:!1,saveExportCar:[],tableDataFlag:!1,barProgress:0,message:{visible:!1,level:"success",content:""}}},watch:{tableDataFlag(e,t){e?(document.querySelector("#app").style.cursor="wait",document.querySelector(".back-icon").style.pointerEvents="none",document.querySelector(".record-header").style.pointerEvents="none",document.querySelector(".o-console-er").style.pointerEvents="none",document.querySelector(".o-pul-er").style.pointerEvents="none",document.querySelector(".o-menu").style.pointerEvents="none"):(document.querySelector("#app").style.cursor="",document.querySelector(".back-icon").style.pointerEvents="",document.querySelector(".record-header").style.cursor="",document.querySelector(".o-console-er").style.pointerEvents="",document.querySelector(".o-pul-er").style.pointerEvents="",document.querySelector(".o-menu").style.pointerEvents="")}},computed:{DIDVersion(){return[...new Set(this.tableList.map(e=>e.did))].map(e=>({value:e}))},filterTableList(){let e=JSON.parse(JSON.stringify(this.tableList.slice()));if(console.log("this.tableList1111",e,this.SoftStatusVal),this.ECUVal&&(e=e.filter(t=>t.ecu==this.ECUVal)),this.DIDVal.length>0){e=e.filter(r=>this.DIDVal.some(a=>a.value==r.did));let t=[];t=this.DIDVal.map(r=>r.value),t.toString()=="0xF1A0"&&this.tableList.some(r=>r.currentVersion)?this.comparisonFlag=!0:this.comparisonFlag=!1}return e.length>0&&e.forEach((t,r)=>{t.ecu==="VCCD"&&(t.did.includes("F193")&&(e[r].level="HWBN"),t.did.includes("F180")&&(e[r].level="SPBL"),t.did.includes("F1A0")&&(e[r].level="SFA/SFC/SFCP"),t.did.includes("F103")&&(e[r].level="SWDI"),t.did.includes("F104")&&(e[r].level="SWDI"),t.did.includes("F105")&&(e[r].level="SWDI"))}),console.log("newTabList",e),this.SoftStatusVal&&(e=e.filter(t=>t.status==this.SoftStatusVal)),console.log("newTabList",e),e}},mounted:async function(){y.report("trackPage",{page:"读取软硬件版本号",tip:"1174.7.0.1.27755"}),this.tableList=this.$ls.get("tableList")||[],await this.getCarVinCode(),await this.pullCloudECU()},methods:{showMessage({level:e,content:t,timeout:r}){clearTimeout(L),e!=null&&(this.message.level=e),t!=null&&(this.message.content=t),this.message.visible=!0,r>0&&(L=setTimeout(()=>{console.log(L,"msgTimer"),this.message.visible=!1},r))},hideMessage(){this.message.visible=!1},async clickSearch(){await this.pullCloudECU()},reSet(){this.ECUVal="",this.DIDVal=[],this.SoftStatusVal=""},async pullCloudECU(){y.report("track","click",{element_name:"拉云端",asset_name:"",tip:"1174.7.0.1.27756"}),console.log("this.carInfo.VINNumber",this.carInfo.VINNumber),this.showMessage({level:"loading",content:"同步中..."}),_.ecuver.getEcuVer({vin:this.carInfo.VINNumber,vehicleConfig:"低配"}).then(e=>{if(console.log("ecuver.res>>",e.data),e.data.code=="S00"){this.showMessage({timeout:3e3,level:"success",content:"同步云端成功"});let t=e.data.content;const r=JSON.parse(t||"[]").respData||[];r.forEach(a=>{[a["0xF193"],a["0xF180"],a["0xF1A0"],a["0xF17F"]]=a.version.match(/([^,]+),([^,]+),([^,]+),([^,]+)/).slice(1),a["0xF1A0"]=w(a["0xF1A0"])}),r.forEach(a=>{["0xF193","0xF180","0xF1A0","0xF17F"].forEach(l=>{let n=this.tableList.find(i=>i.ecu===a.ecu&&i.did===l);n||(this.tableList.push({ecu:"",did:"",level:"",status:"",currentVersion:"",version:"",deadline:""}),n=this.tableList[this.tableList.length-1]),n.ecu=a.ecu,n.did=l,n.version=a[l],n.deadline=a.deadline===null?"--":a.deadline})}),this.$ls.set("tableList",this.tableList)}else this.showMessage({timeout:3e3,level:"success",content:"云端无数据"})}).catch(()=>{this.showMessage({timeout:3e3,level:"error",content:"未同步，云端无数据"})})},async getCarVinCode(){let e=await _.base.getCarVin(),t=e.data;e.status==200&&(this.carInfo.VINNumber=t,this.carInfo.VINNumber||(this.carInfo.VINNumber="LKBCC2MS8NK108013"))},async pullECUVersion(){y.report("track","click",{element_name:"拉本地",asset_name:"",tip:"1174.7.0.1.27757"}),this.tableDataFlag=!0,this.addProgress(),_.doip.getEcuInfoWithDID().then(e=>{let t=e.data;this.saveExportCar=t,t.forEach(r=>{Object.keys(r).forEach(a=>{r[a].forEach(l=>{const n=Object.keys(l)[0];let i=l[n];n==="0xF1A0"&&(i=w(i));let c=this.tableList.find(d=>d.ecu===a&&d.did===n);c||(this.tableList.push({ecu:"",did:"",level:"",status:"",currentVersion:"",version:"",deadline:""}),c=this.tableList[this.tableList.length-1]),c.ecu=a,c.did=n,c.currentVersion=i})})}),this.barProgress=100,this.tableDataFlag=!1,clearInterval(E),this.$ls.set("tableList",this.tableList)}).catch(e=>{this.pullDataLoaded=!0}).finally(e=>{this.barProgress=100,this.tableDataFlag=!1,clearInterval(E)})},async exportResult(){y.report("track","click",{element_name:"导出结果",asset_name:"",tip:"1174.7.0.1.27764"});let t="pull-car-ECU"+new Date().valueOf(),r="";await R.choosePath({directory:r,dialogType:"SAVE_DIALOG",saveFilename:t+".csv",fileTypes:["CSV文件 (*.csv;*.CSV)"],allow_multiple:!1}).then(a=>{if(console.log("saveFilename2222",t,r),a.data.directory){let l=new Map,n=[],i=[];this.tableList.forEach(s=>{let h=s.ecu+"-"+s.did;l.set(h,s.currentVersion),n.push(s.ecu),i.push(s.did)}),n=[...new Set(n)].sort(),i=[...new Set(i)].sort();let c=[],d=[];d.push("编号"),d.push(...n),c.push(d),i.forEach((s,h)=>{let F=[];F.push(s),c.push(F),n.forEach(I=>{let D=I+"-"+s;console.log("newKey",D);let k=h+1;c[k].push(l.get(D)||"")})}),console.log("tabArr",c),c=c.map(s=>s.map(h=>'"'+h+'"').join()),console.log("tabArr",c);let v=c.join("\n");console.log("finArr",v),_.blf.exportExeLog({content:v,directory:a.data.directory}).then(s=>{s.data.code=="0"&&this.showMessage({timeout:5e3,level:"success",content:"导出成功"})}).catch(s=>{console.log(s)})}})},addProgress(){let e=3e5;E=setInterval(()=>{this.barProgress+=100/300,e--,e===0&&clearInterval(E)},3e4)}}},g=e=>(B("data-v-d23f49fd"),e=e(),T(),e),O=["data-disabled"],H={class:"o-pul-er"},j={class:"o-btn-wrap"},K=["data-empty"],Z=g(()=>o("div",{class:"o-console-wrap"},[o("div",{class:"o-console-title"},"搜素结果")],-1)),J={class:"o-select-er"},z={class:"o-select-wrap"},G={class:"select-ecu-wrap"},X=g(()=>o("span",{class:"record-header-message"},"ECU：",-1)),Q={class:"select-did-wrap"},Y=g(()=>o("span",{class:"record-header-message"},"DID：",-1)),$={class:"select-soft-status-wrap"},ee=g(()=>o("span",{class:"record-header-message"},"软件状态：",-1)),se={class:"o-button-wrap"},te={key:0,class:"board-spin-er"},oe={class:"board-spin"},le={class:"board-progress"},re=g(()=>o("div",{class:"board-spin-text"},"正在拉取车辆ECU版本，整个过程需要几分钟…",-1)),ae={key:1,class:"o-table"},ne=g(()=>o("thead",{class:"o-table-thead"},[o("tr",null,[o("th",{class:"o-table-cell"},"ECU"),o("th",{class:"o-table-cell"},"DID"),o("th",{class:"o-table-cell"},"软件层级"),o("th",{class:"o-table-cell"},"软件状态"),o("th",{class:"o-table-cell"},"当前版本号"),o("th",{class:"o-table-cell"},"SRC最新版本号"),o("th",{class:"o-table-cell"},"版本更新截止日期")])],-1)),ce={class:"o-table-tbody"},ie={class:"o-cell"},de={class:"o-cell"};function ue(e,t,r,a,l,n){const i=C("Header"),c=C("Button"),d=C("v-select"),v=C("Message");return V(),b("div",{class:"pull-dt-page","data-disabled":l.tableDataFlag},[u(i,{title:"读取软硬件版本号",quitConfirm:!0,showRight:!0,carNum:e.$props.store.connectCar.carNum,connectStatus:e.$props.store.connectCar.status,recentTest:e.$props.store.connectCar.latest},null,8,["carNum","connectStatus","recentTest"]),o("div",H,[o("div",j,[u(c,{style:{"margin-right":"8px"},type:"primary",progress:l.pullLoadingProgress,loading:l.pullLocalLoading,onClick:n.pullECUVersion},{default:m(()=>[S("拉取车辆ECU版本")]),_:1},8,["progress","loading","onClick"]),u(c,{progress:l.pullLoadingProgress,loading:l.pullCloudLoading,onClick:n.pullCloudECU},{default:m(()=>[S("同步云端SRC版本号")]),_:1},8,["progress","loading","onClick"])])]),o("div",{class:"o-console-er","data-empty":l.tableList.length===0},[Z,o("div",J,[o("div",z,[o("div",G,[X,u(d,{options:l.ECUVersion,label:"value",modelValue:l.ECUVal,"onUpdate:modelValue":t[0]||(t[0]=s=>l.ECUVal=s),class:"chf-input-ecu"},null,8,["options","modelValue"])]),o("div",Q,[Y,u(d,{options:n.DIDVersion,label:"value",modelValue:l.DIDVal,"onUpdate:modelValue":t[1]||(t[1]=s=>l.DIDVal=s),multiple:"",class:"chf-input-did"},null,8,["options","modelValue"])]),o("div",$,[ee,u(d,{options:l.softStatus,label:"value",modelValue:l.SoftStatusVal,"onUpdate:modelValue":t[2]||(t[2]=s=>l.SoftStatusVal=s),class:"chf-input-status"},null,8,["options","modelValue"])])]),o("div",se,[u(c,{type:"primary",onClick:n.clickSearch},{default:m(()=>[S("搜 索")]),_:1},8,["onClick"]),u(c,{onClick:n.reSet},{default:m(()=>[S("重 置")]),_:1},8,["onClick"]),u(c,{onClick:n.exportResult},{default:m(()=>[S("导出结果")]),_:1},8,["onClick"])])]),l.tableDataFlag?(V(),b("div",te,[o("div",oe,[o("div",le,[o("div",{class:"board-progress-bar",style:p("--percent:"+l.barProgress)},null,4)])]),re])):(V(),b("table",ae,[ne,o("tbody",ce,[(V(!0),b(M,null,P(n.filterTableList,(s,h)=>(V(),b("tr",{key:h},[o("td",{class:"o-table-cell o-width-short",style:p(l.comparisonFlag&&s.currentVersion!==s.srcVersion&&s.currentVersion!=="--"?"background-color:#fff2f2":"")},f(s.ecu),5),o("td",{class:"o-table-cell o-width-short",style:p(l.comparisonFlag&&s.currentVersion!==s.srcVersion&&s.currentVersion!=="--"?"background-color:#fff2f2":"")},f(s.did),5),o("td",{class:"o-table-cell o-width-medium",style:p(l.comparisonFlag&&s.currentVersion!==s.srcVersion&&s.currentVersion!=="--"?"background-color:#fff2f2":"")},f(s.level),5),o("td",{class:"o-table-cell o-width-short",style:p(l.comparisonFlag&&s.currentVersion!==s.srcVersion&&s.currentVersion!=="--"?"background-color:#fff2f2":"")},f(s.status),5),o("td",{class:"o-table-cell o-overflow-hidden o-width-long",style:p(l.comparisonFlag&&s.currentVersion!==s.srcVersion&&s.currentVersion!=="--"?"background-color:#fff2f2":"")},[o("span",ie,f(s.currentVersion),1)],4),o("td",{class:"o-table-cell o-overflow-hidden o-width-long",style:p(l.comparisonFlag&&s.currentVersion!==s.srcVersion&&s.currentVersion!=="--"?"background-color:#fff2f2":"")},[o("span",de,f(s.version),1)],4),o("td",{class:"o-table-cell o-width-medium",style:p(l.comparisonFlag&&s.currentVersion!==s.srcVersion&&s.currentVersion!=="--"?"background-color:#fff2f2":"")},f(s.deadline),5)]))),128))])]))],8,K),u(v,{message:l.message},null,8,["message"])],8,O)}const me=x(W,[["render",ue],["__scopeId","data-v-d23f49fd"]]);export{me as default};
