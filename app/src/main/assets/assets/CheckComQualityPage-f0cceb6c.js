import{H as E}from"./Header-fd40c168.js";import{B as F}from"./Button-2b784c4f.js";import{M as D}from"./Message-793e2c7b.js";import{C as P}from"./Cascader-46c79275.js";import{C as M}from"./CopyPath-9b72c79b.js";import{_ as B,S as _,k as x,e as m,j as g,r as h,c as f,h as a,d as s,i as d,a as c,w as v,v as b,t as I,o as C,p as A,b as j}from"./index-08e75979.js";import{n as N}from"./index-3236867f.js";let T=0,p=0,y=0,S=0;const O={props:["store","closeFlag"],components:{Button:F,Header:E,Message:D,Cascader:P,CopyPath:M},data(){return{tolerance:"0.2",chartDataLoaded:!0,directory:"",pullList:{total:{label:"全量采集数据",size:"",paths:"/persistence/vde/pool,/tmp/vde/pool"},dialogMaster:{label:"DialogMaster日志",size:"",paths:"/log/DiagMaster,/persistence/DiagMaster"}},modal:{visible:!1,resultVisible:!1},pullLoading:!1,pullLoadingProgress:"",consoleText:"",message:{visible:!1,level:"",content:""},onFlag:!0,dbcVal:[_.DEFAULT[0].value,_.DEFAULT[0].children[0].value],sdbCustom:this.$ls.get("blfread_sdbData")||[]}},watch:{closeFlag(e){this.onFlag==!1&&this.showMessage({timeout:-1})},chartDataLoaded(e,t){e?(document.querySelector("#app").style.cursor="",document.querySelector(".choose-cation").style.pointerEvents="",document.querySelector(".o-menu").style.pointerEvents="",document.querySelector(".start-rec").style.pointerEvents="",document.querySelector(".o-console-er").style.pointerEvents="",document.querySelector(".record-header").style.pointerEvents="",document.querySelector(".o-che-input").style.pointerEvents="",document.querySelector(".input-cation").style.pointerEvents=""):(document.querySelector("#app").style.cursor="wait",document.querySelector(".choose-cation").style.pointerEvents="none",document.querySelector(".o-console-er").style.pointerEvents="none",document.querySelector(".record-header").style.pointerEvents="none",document.querySelector(".o-menu").style.pointerEvents="none",document.querySelector(".start-rec").style.pointerEvents="",document.querySelector(".o-che-input").style.pointerEvents="none",document.querySelector(".input-cation").style.pointerEvents="none")}},computed:{pullDataValid(){return!!(this.directory&&this.tolerance)},quitConfirm(){return!!this.directory},dbcVerOpts(){return[..._.DEFAULT,{label:"自定义模板",value:"自定义模板",children:this.sdbCustom.length>0?this.sdbCustom.map(t=>({label:t.sdb,value:t.sdb,files:t.files,comments:t.comments})):null}]},curTpl(){if(this.dbcVal[0]==="自定义模板"){let e=this.sdbCustom.find(t=>t.sdb===this.dbcVal[1]);return{carType:"custom",sdb:this.dbcVal[1],files:e==null?void 0:e.files,comments:e==null?void 0:e.comments}}return{carType:this.dbcVal[0],sdb:this.dbcVal[1]}}},mounted(){g.report("trackPage",{page:"检查通讯质量",tip:"1174.2.0.1.27748"})},unmounted(){},methods:{choosePath(){x.choosePath({directory:this.directory,dialogType:"OPEN_DIALOG",fileTypes:["BLF文件 (*.blf;*.BLF)"],allow_multiple:!1}).then(e=>{e.data.directory&&(this.directory=N(e.data.directory))})},heartConsole(){console.log("heartTimer",p),m.blfCheck.getExeLog().then(({data:e})=>{e.data.length>0&&(this.consoleText+=e.data.join("\n").replace(/Active code page: 65001/g,"").replace(/^\s+/g,"")+"\n"),clearTimeout(S),S=setTimeout(()=>{console.log(S,"bodyTimer"),window.document.querySelector(".o-console-body")&&(window.document.querySelector(".o-console-body").scrollTop=99999999)})})},async cheFile(){g.report("track","click",{element_name:"开始检查",asset_name:this.directory+";"+this.dbcVal.join(),tip:"1174.2.0.1.27749"}),this.onFlag=!1,this.chartDataLoaded=!1,clearInterval(p),clearTimeout(y),p=setInterval(this.heartConsole,1500),this.consoleText="检查中...\n",await m.blfCheck.start_check({path:this.directory,tolerance:this.tolerance,...this.curTpl}).then(e=>{let t=e.data;e.status==200&&t.length>0&&(this.consoleText+=t.join("\n")+"\n")}).catch(e=>{this.consoleText+="\n检查中断\n"}).finally(()=>{this.onFlag=!0,clearTimeout(y),y=setTimeout(()=>{console.log(y,"endTimer"),clearInterval(p),this.consoleText+="\n检查结束\n"},2e3)}),this.chartDataLoaded=!0},async stopCheFile(){this.onFlag=!0,this.chartDataLoaded=!0,this.dataLoading=!1,this.consoleText+="\n已中断检查\n",await m.blfCheck.stopAll().then(e=>{let t=e.data;e.status==200&&(this.consoleText+=t+"\n")}).catch(e=>{this.consoleText+="\n中断检查失败\n"}),clearInterval(p)},async exportResult(){g.report("track","click",{element_name:"导出结果",asset_name:this.directory+";"+this.dbcVal.join(),tip:"1174.2.0.1.27762"});let e=this.directory.split("/").slice(-1)[0],t=this.directory.split(e)[0];console.log("1"),console.log("directoryStr",t),await x.choosePath({directory:t,dialogType:"SAVE_DIALOG",saveFilename:e+".txt",fileTypes:["所有文件 (*.*)"],allow_multiple:!1}).then(n=>{n.data.directory&&m.blfCheck.exportExeLog({content:this.consoleText,directory:n.data.directory}).then(k=>{k.data.code=="0"&&this.showMessage({timeout:5e3,level:"success",content:"导出成功"})})})},showMessage({level:e,content:t,timeout:n}){clearTimeout(T),e!=null&&(this.message.level=e),t!=null&&(this.message.content=t),this.message.visible=!0,n>0&&(T=setTimeout(()=>{console.log(T,"msgTimer"),this.message.visible=!1},n))},hideMessage(){this.message.visible=!1},cannel(){this.modal.visible=!1},submit(){this.modal.visible=!1,this.onFlag=!this.onFlag,this.stopCheFile()},resultCannel(){this.modal.resultVisible=!1}}},i=e=>(A("data-v-35036f13"),e=e(),j(),e),H={class:"pull-dt-page"},U={class:"o-pul-er"},z=i(()=>s("div",{class:"o-pul-title"},"blf文件导入配置",-1)),R={class:"o-pul-p choose-cation"},G=i(()=>s("span",{style:{color:"red"}},"* ",-1)),Q=i(()=>s("span",{class:"record-header-message"},"blf 文件：",-1)),J={class:"o-pul-path"},K={class:"o-pul-p input-cation"},W=i(()=>s("span",{style:{color:"red"}},"* ",-1)),X=i(()=>s("span",{class:"record-header-message"},"DBC 版本：",-1)),Y={class:"o-che-input"},Z={key:0,class:"o-pul-p start-rec"},$=i(()=>s("i",{class:"play-icon"},null,-1)),ee={key:1,class:"o-pul-p start-rec"},te=i(()=>s("i",{class:"stop-icon"},null,-1)),se=["data-empty"],oe={class:"o-console-wrap"},le=i(()=>s("div",{class:"o-console-title"},"报文检查结果",-1)),ae=["data-loading"],ie={class:"o-modal-wrap"},ne={class:"o-modal-header"},ce={class:"o-modal-header-wrap"},re=i(()=>s("div",{class:"o-modal-title"},"提示",-1)),de=i(()=>s("div",{class:"o-modal-container"},[s("span",{class:"record-header-message"},"任务还在执行中，此时关闭TSP助手会终断此任务，确认要继续关闭吗？")],-1)),he={class:"o-modal-footer"},pe={class:"o-modal-footer-wrap"};function ue(e,t,n,k,o,l){const w=h("Header"),r=h("Button"),V=h("CopyPath"),L=h("Cascader"),q=h("Message");return C(),f("div",H,[a(w,{title:"检查报文",quitConfirm:l.quitConfirm,showRight:!0,carNum:e.$props.store.connectCar.carNum,connectStatus:e.$props.store.connectCar.status,recentTest:e.$props.store.connectCar.latest},null,8,["quitConfirm","carNum","connectStatus","recentTest"]),s("div",U,[z,s("div",R,[G,Q,a(r,{onClick:l.choosePath,class:"choose-path"},{default:d(()=>[c("选择文件")]),_:1},8,["onClick"]),c("  "),s("span",J,[a(V,{path:o.directory,length:60},null,8,["path"])])]),s("div",K,[W,X,s("div",Y,[a(L,{options:l.dbcVerOpts,modelValue:o.dbcVal,"onUpdate:modelValue":t[0]||(t[0]=u=>o.dbcVal=u)},null,8,["options","modelValue"])])]),o.onFlag?(C(),f("div",Z,[a(r,{type:"primary",disabled:!l.pullDataValid,progress:o.pullLoadingProgress,loading:o.pullLoading,onClick:l.cheFile},{default:d(()=>[$,c("开始检查")]),_:1},8,["disabled","progress","loading","onClick"])])):(C(),f("div",ee,[a(r,{type:"primary",progress:o.pullLoadingProgress,loading:o.pullLoading,onClick:l.stopCheFile},{default:d(()=>[te,c("停止检查")]),_:1},8,["progress","loading","onClick"])]))]),s("div",{class:"o-console-er","data-empty":o.consoleText===""},[s("div",oe,[le,v(a(r,{onClick:t[1]||(t[1]=u=>l.exportResult()),class:"export-result"},{default:d(()=>[c("导出结果")]),_:1},512),[[b,o.consoleText]])]),v(s("div",{class:"o-console-body","data-loading":!o.chartDataLoaded},I(o.consoleText),9,ae),[[b,o.consoleText]])],8,se),v(s("div",ie,[s("div",ne,[s("div",ce,[re,s("i",{class:"o-modal-title-close",onClick:t[2]||(t[2]=(...u)=>l.cannel&&l.cannel(...u))})]),de,s("div",he,[s("div",pe,[a(r,{style:{width:"52px"},onClick:l.cannel},{default:d(()=>[c("取消")]),_:1},8,["onClick"]),a(r,{type:"primary",style:{width:"52px",margin:"0 20px 0 10px"},onClick:l.submit},{default:d(()=>[c("确定")]),_:1},8,["onClick"])])])])],512),[[b,this.modal.visible]]),a(q,{message:o.message},null,8,["message"])])}const Ce=B(O,[["render",ue],["__scopeId","data-v-35036f13"]]);export{Ce as default};
